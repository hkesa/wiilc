<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WiilC Family</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- üî• 1. ÂºïÂÖ• Firebase Ê†∏ÂøÉËàáË≥áÊñôÂ∫´ (CompatÁâàÊú¨) üî• -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #4169E1 0%, #6495ED 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        * {
            font-size: 18px !important;
            line-height: 1.5 !important;
        }
        #navbar {
            transition: all 0.3s ease-in-out;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        #navbar.shrink {
            padding-top: 5px;
            padding-bottom: 5px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(to right, #4169E1, #5a80e8);
            color: white !important;
            border-radius: 12px;
            padding: 10px 20px;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.95); }

        .btn-add-item {
            background: #FF007F;
            color: white !important;
            border: 1px solid #FF007F;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: bold;
            transition: transform 0.1s, background 0.2s;
        }
        .btn-add-item:active { transform: scale(0.95); }
        .btn-add-item:hover { background: #D10068; border-color: #D10068; }

        .btn-find {
            background: white;
            color: #4169E1 !important;
            border: 1px solid #4169E1;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: bold;
            transition: transform 0.1s, background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-find:hover { background: #f0f4ff; }

        .btn-region {
            background: white;
            color: #4169E1 !important;
            border: 1px solid #4169E1;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: bold;
            flex: 1;
            text-align: center;
            transition: all 0.2s;
        }
        .btn-region.active {
            background: #FF007F;
            border-color: #FF007F;
            color: white !important;
        }

        .btn-danger { background: #ff6b6b; color: white !important; border-radius: 12px; padding: 10px 20px; }
        .btn-success { background: #20bf6b; color: white !important; border-radius: 12px; padding: 10px 20px; }
        
        .btn-link, .btn-map-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            text-decoration: none;
            padding: 2px 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .btn-link { color: #4169E1; background: #edf2ff; border: 1px solid #bfdbfe; }
        .btn-link:hover { background: #dbeafe; }
        .btn-map-link { color: #d946ef; background: #fae8ff; border: 1px solid #f0abfc; }
        .btn-map-link:hover { background: #f5d0fe; }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .item-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 7px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: pointer;
        }
        .item-card:active { transform: scale(0.99); background-color: #f9fafb; }

        input, select, textarea {
            background-color: #ffffff !important;
            -webkit-appearance: none;
            appearance: none;
        }
        input[type="date"] { background-color: #ffffff !important; }

        .select-chip {
            border: 2px solid #ddd;
            border-radius: 20px;
            padding: 5px 15px;
            cursor: pointer;
            background: white;
            color: #888;
            display: inline-block;
            margin: 3px;
            user-select: none;
        }
        .select-chip.selected { border-color: #4169E1; background: #edf2ff; color: #4169E1; font-weight: bold; }

        .display-chip {
            font-size: 14px !important;
            background: #eff6ff;
            color: #4169E1;
            border: 1px solid #bfdbfe;
            padding: 2px 8px;
            border-radius: 12px;
            white-space: nowrap;
            display: inline-block;
        }

        #mobile-menu {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        #mobile-menu.open { max-height: 500px; opacity: 1; }

        #find-dropdown {
            position: absolute; top: 100%; left: 0; margin-top: 5px;
            background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 200px; display: none; z-index: 50; padding: 5px;
        }
        #find-dropdown.show { display: block; }
        .find-option { padding: 10px 15px; cursor: pointer; border-radius: 8px; transition: background 0.1s; }
        .find-option:hover { background-color: #f3f4f6; }
        .find-option.active { color: #4169E1; font-weight: bold; background-color: #edf2ff; }
        
        #offline-banner {
            background-color: #FFF3CD; color: #856404; border: 1px solid #FFEEBA;
            padding: 10px; text-align: center; font-weight: bold;
            font-size: 16px !important; display: none;
            margin-top: 80px; margin-bottom: -80px; position: relative; z-index: 40;
        }

        #fireworks-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999;
        }

        #item-modal {
            align-items: flex-start !important;
            padding-top: 96px !important;
            padding-bottom: 80px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;  
        }
        @media (min-width: 640px) {
            #item-modal {
                align-items: center !important;
                padding-top: 2rem !important;
                padding-bottom: 2rem;
            }
        }
        #modal-title {
            text-align: center;
            font-size: 21px !important;
            font-weight: bold;
            width: 100%;
        }

        /* MJ Record Styles */
        .mj-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Force scroll */
        }
        .mj-table th, .mj-table td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: center;
            white-space: nowrap;
        }
        .mj-table th {
            background-color: #f8faff;
            color: #4169E1;
            font-weight: bold;
        }
        .mj-table .total-row {
            background-color: #edf2ff;
            color: #4169E1;
            font-weight: bold;
        }
        .mj-table tr:nth-child(even) { background-color: #fcfcfc; }
        
        .mj-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
        }
        .mj-label { width: 80px; font-weight: bold; color: #555; }
        
        /* New +/- Buttons */
        .mj-sign-btn {
            width: 26px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: #888;
        }
        .mj-sign-btn.active {
            background: #4169E1;
            color: white;
            border-color: #4169E1;
        }

        /* Guests Row Container */
        .guests-row {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .guest-item {
            flex: 0 0 auto;
            width: 120px;
            border: 1px solid #eee;
            padding: 5px;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .guest-item .mj-label { width: auto; display: block; margin-bottom: 2px; font-size: 14px !important; }
        
        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .calendar-header {
            text-align: center;
            font-weight: bold;
            color: #4169E1;
            padding: 5px;
        }
        .calendar-day {
            background: white;
            border-radius: 8px;
            min-height: 60px;
            padding: 5px;
            font-size: 14px !important;
            border: 1px solid #eee;
            position: relative;
        }
        .day-number { font-weight: bold; }
        .holiday-name {
            font-size: 12px !important;
            line-height: 1.2 !important;
            margin-top: 2px;
            word-wrap: break-word; 
            word-break: normal;
        }
        .text-red-holiday { color: #ef4444; }
        .text-black-day { color: #333; }
    </style>
</head>
<body class="pb-20">

    <canvas id="fireworks-canvas"></canvas>

    <!-- Â∞éËà™Ê¨Ñ -->
    <nav id="navbar" class="fixed top-0 w-full z-50 px-4 py-3">
        <div class="max-w-6xl mx-auto relative">
            <div class="flex items-center justify-between">
                <div class="font-bold text-[#4169E1] text-xl flex-shrink-0 z-10 cursor-pointer" onclick="location.reload()">WiilC Family</div>
                <div class="md:hidden font-bold text-gray-600 truncate px-2 absolute left-1/2 transform -translate-x-1/2" id="mobile-page-title">üçü To Eat</div>
                <button class="md:hidden text-[#4169E1] p-2 focus:outline-none z-10" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
                <div class="hidden md:flex space-x-2">
                    <button onclick="switchTab('calendar')" class="nav-btn px-4 py-2 rounded-full transition-colors duration-200" id="nav-calendar-d">üóìÔ∏è HKÔºèNZ Holiday</button>
                    <button onclick="switchTab('mjrecord')" class="nav-btn px-4 py-2 rounded-full transition-colors duration-200" id="nav-mjrecord-d">üÄÑ MJ Record</button>
                    <button onclick="switchTab('todo')" class="nav-btn px-4 py-2 rounded-full transition-colors duration-200" id="nav-todo-d">üõ†Ô∏è To Do</button>
                    <button onclick="switchTab('togo')" class="nav-btn px-4 py-2 rounded-full transition-colors duration-200" id="nav-togo-d">üöÄ To Go</button>
                    <button onclick="switchTab('toeat')" class="nav-btn px-4 py-2 rounded-full transition-colors duration-200" id="nav-toeat-d">üçü To Eat</button>
                    <button onclick="switchTab('tobuy')" class="nav-btn px-4 py-2 rounded-full transition-colors duration-200" id="nav-tobuy-d">üõí To Buy</button>
                    <button onclick="switchTab('recurring')" class="nav-btn px-4 py-2 rounded-full transition-colors duration-200" id="nav-recurring-d">üîÑ Recurring</button>
                    <button onclick="switchTab('completed')" class="nav-btn px-4 py-2 rounded-full transition-colors duration-200" id="nav-completed-d">üèÅ Completed</button>
                </div>
            </div>
            <div id="mobile-menu" class="md:hidden mt-2 flex flex-col space-y-2 pb-2">
                <button onclick="switchTab('calendar')" class="nav-btn mobile-nav-item p-3 rounded-lg text-left" id="nav-calendar-m">üóìÔ∏è HKÔºèNZ Holiday</button>
                <button onclick="switchTab('mjrecord')" class="nav-btn mobile-nav-item p-3 rounded-lg text-left" id="nav-mjrecord-m">üÄÑ MJ Record</button>
                <button onclick="switchTab('todo')" class="nav-btn mobile-nav-item p-3 rounded-lg text-left" id="nav-todo-m">üõ†Ô∏è To Do</button>
                <button onclick="switchTab('togo')" class="nav-btn mobile-nav-item p-3 rounded-lg text-left" id="nav-togo-m">üöÄ To Go</button>
                <button onclick="switchTab('toeat')" class="nav-btn mobile-nav-item p-3 rounded-lg text-left" id="nav-toeat-m">üçü To Eat</button>
                <button onclick="switchTab('tobuy')" class="nav-btn mobile-nav-item p-3 rounded-lg text-left" id="nav-tobuy-m">üõí To Buy</button>
                <button onclick="switchTab('recurring')" class="nav-btn mobile-nav-item p-3 rounded-lg text-left" id="nav-recurring-m">üîÑ Recurring</button>
                <button onclick="switchTab('completed')" class="nav-btn mobile-nav-item p-3 rounded-lg text-left" id="nav-completed-m">üèÅ Completed</button>
            </div>
        </div>
    </nav>

    <div id="offline-banner">
        ‚ö†Ô∏è Â∞öÊú™ÈÄ£Á∑ö Firebase - Ë≥áÊñôÁÑ°Ê≥ïÂÑ≤Â≠ò<br>
        <span style="font-size: 14px; font-weight: normal;">Ë´ãÁ∑®ËºØÁ®ãÂºèÁ¢ºÂ°´ÂÖ•ÊÇ®ÁöÑ API Key ‰ª•ÂïüÁî®ÂÆåÊï¥ÂäüËÉΩ</span>
    </div>

    <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄ -->
    <main class="max-w-6xl mx-auto mt-28 px-4">
        
        <!-- Header ÂçÄÂ°ä -->
        <div class="hidden md:grid grid-cols-3 items-center mb-6 glass-card p-4 relative z-20">
            <!-- Left Controls -->
            <div class="relative">
                <div id="desktop-find-container">
                    <button onclick="toggleFindDropdown(this)" id="btn-find-desktop" class="btn-find">
                        <i class="fas fa-filter"></i> <span id="find-label-d">Filter: All</span>
                    </button>
                    <div id="find-dropdown-d" class="find-dropdown-menu hidden absolute top-12 left-0 w-48 bg-white rounded-xl shadow-xl border border-gray-100 p-2 z-50">
                        <div class="find-option active" onclick="setFilter('All')">All</div>
                        <div class="find-option" onclick="setFilter('Sabrina')">Sabrina</div>
                        <div class="find-option" onclick="setFilter('Agatha')">Agatha</div>
                        <div class="find-option" onclick="setFilter('Derek')">Derek</div>
                        <div class="find-option" onclick="setFilter('Justin')">Justin</div>
                        <div class="find-option" onclick="setFilter('Val')">Val</div>
                    </div>
                </div>
                <div id="desktop-calendar-controls" class="hidden flex gap-2">
                    <button onclick="setCalendarRegion('HK')" class="btn-region active" id="btn-hk-d">HK</button>
                    <button onclick="setCalendarRegion('NZ')" class="btn-region" id="btn-nz-d">NZ</button>
                </div>
            </div>
            
            <h1 id="desktop-page-title" class="font-bold text-[#4169E1] text-center">üçü Food To Eat</h1>
            
            <div id="desktop-add-container" class="flex justify-end">
                <button onclick="openModal()" class="btn-add-item shadow-lg flex items-center gap-2">
                    <i class="fas fa-plus"></i> <span id="desktop-add-text">Add Item</span>
                </button>
            </div>
        </div>

        <!-- Mobile Controls -->
        <div class="md:hidden mb-4 flex gap-2">
            <div class="relative flex-1" id="mobile-find-container">
                <button onclick="toggleFindDropdown(this)" id="btn-find-mobile" class="btn-find w-full justify-center">
                    <i class="fas fa-filter"></i> <span id="find-label-m">Filter: All</span>
                </button>
                <div id="find-dropdown-m" class="find-dropdown-menu hidden absolute top-12 left-0 w-full bg-white rounded-xl shadow-xl border border-gray-100 p-2 z-50">
                    <div class="find-option active" onclick="setFilter('All')">All</div>
                    <div class="find-option" onclick="setFilter('Sabrina')">Sabrina</div>
                    <div class="find-option" onclick="setFilter('Agatha')">Agatha</div>
                    <div class="find-option" onclick="setFilter('Derek')">Derek</div>
                    <div class="find-option" onclick="setFilter('Justin')">Justin</div>
                    <div class="find-option" onclick="setFilter('Val')">Val</div>
                </div>
            </div>
            <div id="mobile-calendar-controls" class="hidden flex flex-1 gap-2">
                <button onclick="setCalendarRegion('HK')" class="btn-region active" id="btn-hk-m">HK</button>
                <button onclick="setCalendarRegion('NZ')" class="btn-region" id="btn-nz-m">NZ</button>
            </div>

            <div class="flex-1" id="mobile-add-container">
                <button id="mobile-add-btn" onclick="openModal()" class="btn-add-item shadow-lg flex items-center gap-2 w-full justify-center">
                    <i class="fas fa-plus"></i> <span id="mobile-add-text">Add Item</span>
                </button>
            </div>
        </div>

        <!-- Recurring Á∏ΩÁµêÂçÄÂ°ä -->
        <div id="recurring-summary" class="hidden glass-card p-4 mb-4 bg-purple-50 border-purple-200">
            <div class="text-center">
                <div id="recurring-total-display" class="text-2xl font-bold text-[#4169E1]">Average Payment NZ$0 / mo</div>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendar-view" class="hidden glass-card p-4 mb-6">
            <div class="flex justify-between items-center mb-4">
                <button onclick="changeMonth(-1)" class="text-[#4169E1]"><i class="fas fa-chevron-left"></i></button>
                <h2 id="calendar-month-year" class="text-xl font-bold text-[#4169E1]">Month Year</h2>
                <button onclick="changeMonth(1)" class="text-[#4169E1]"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-header text-red-holiday">Sun</div>
                <div class="calendar-header">Mon</div>
                <div class="calendar-header">Tue</div>
                <div class="calendar-header">Wed</div>
                <div class="calendar-header">Thu</div>
                <div class="calendar-header">Fri</div>
                <div class="calendar-header">Sat</div>
            </div>
            <div id="calendar-days" class="calendar-grid"></div>
        </div>

        <!-- MJ Record Table View -->
        <div id="mj-record-view" class="hidden glass-card p-0 mb-6 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="mj-table">
                    <thead>
                        <!-- V1.20: Total Row -->
                        <tr class="total-row" id="mj-header-totals">
                            <!-- Injected by JS -->
                        </tr>
                        <tr>
                            <th>Date</th>
                            <th>S</th>
                            <th>A</th>
                            <th>D</th>
                            <th>V</th>
                            <th>ÈäÄÂßê</th>
                            <th>ÊΩò</th>
                            <th>Guest ‚ë†</th>
                            <th>Guest ‚ë°</th>
                            <th>Guest ‚ë¢</th>
                            <th>Guest ‚ë£</th>
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody id="mj-list-container">
                        <!-- JS injects rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Card List View (Standard) -->
        <div id="list-container" class="mb-6"></div>
        
        <div id="empty-state" class="hidden text-center py-10 text-gray-500 glass-card">
            Loading items...
        </div>
        
        <div id="version-footer" class="hidden text-center py-4 text-white text-opacity-80 text-sm font-bold">
            V1.20
        </div>
    </main>

    <!-- Ê®°ÊÖãÊ°Ü -->
    <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex justify-center">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl relative my-4 mx-4">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-blue-50 rounded-t-2xl">
                <h2 id="modal-title" class="font-bold text-[#4169E1]">Add Item</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 border border-gray-300 rounded-full w-8 h-8 flex items-center justify-center transition-colors hover:bg-gray-100 hover:border-gray-400">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div id="modal-content-scroll" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="item-id">
                
                <!-- MJ Record Specific Form -->
                <div id="mj-form-container" class="hidden">
                    <!-- Calculator -->
                    <div class="bg-blue-50 p-4 rounded-xl mb-4">
                        <label class="block text-gray-600 mb-1 font-bold text-sm">Calculator</label>
                        <div class="flex items-center gap-2">
                            <input type="number" inputmode="numeric" id="mj-calc-input" class="w-full border border-blue-200 rounded-lg p-2" placeholder="Enter score (e.g. 50)" oninput="calculateMjScore(this.value)">
                            <div class="text-[#4169E1] font-bold text-xl whitespace-nowrap">‚Üí <span id="mj-calc-result">0</span></div>
                        </div>
                    </div>

                    <div class="mj-input-group">
                        <label class="mj-label">Date</label>
                        <input type="date" id="mj-date" class="w-full border border-gray-300 rounded-lg p-2 bg-white appearance-none">
                    </div>

                    <!-- Players -->
                    <div id="mj-players-container">
                        <!-- JS will inject player inputs -->
                    </div>
                    
                    <!-- Remark for MJ -->
                    <div class="mj-input-group mt-2">
                        <label class="mj-label">Remark</label>
                        <input type="text" id="mj-remark" class="w-full border border-gray-300 rounded-lg p-2" placeholder="Optional">
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                        <span class="font-bold text-lg">Total Sum:</span>
                        <span id="mj-total-sum" class="font-bold text-xl text-[#4169E1]">0</span>
                    </div>
                </div>

                <!-- Standard Item Form -->
                <div id="standard-form-container">
                    <div>
                        <label id="label-title" class="block text-gray-600 mb-1 font-bold">Heading</label>
                        <input type="text" id="input-title" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:border-[#4169E1] transition-colors" placeholder="Enter heading...">
                    </div>

                    <div>
                        <label class="block text-gray-600 mb-1 font-bold">For Who</label>
                        <div id="who-container" class="flex flex-wrap gap-1 border border-gray-300 rounded-lg p-3">
                            <span class="select-chip" onclick="toggleWho(this)" data-value="All">All</span>
                            <span class="select-chip" onclick="toggleWho(this)" data-value="Sabrina">Sabrina</span>
                            <span class="select-chip" onclick="toggleWho(this)" data-value="Agatha">Agatha</span>
                            <span class="select-chip" onclick="toggleWho(this)" data-value="Derek">Derek</span>
                            <span class="select-chip" onclick="toggleWho(this)" data-value="Justin">Justin</span>
                            <span class="select-chip" onclick="toggleWho(this)" data-value="Val">Val</span>
                        </div>
                    </div>

                    <div id="field-frequency" class="hidden">
                        <label class="block text-gray-600 mb-1 font-bold">Frequency</label>
                        <select id="input-frequency" class="w-full border border-gray-300 rounded-lg p-3 bg-white">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Yearly">Yearly</option>
                        </select>
                    </div>
                    <div id="field-payment" class="hidden">
                        <label class="block text-gray-600 mb-1 font-bold">Payment (NZ$)</label>
                        <input type="number" id="input-payment" class="w-full border border-gray-300 rounded-lg p-3 bg-white" placeholder="0">
                    </div>
                    <div id="field-enddate" class="hidden">
                        <label class="block text-gray-600 mb-1 font-bold">End Date</label>
                        <input type="date" id="input-enddate" class="w-full border border-gray-300 rounded-lg p-3 bg-white appearance-none">
                    </div>

                    <div id="field-deadline">
                        <label id="label-deadline" class="block text-gray-600 mb-1 font-bold">Deadline (if any)</label>
                        <input type="date" id="input-deadline" class="w-full border border-gray-300 rounded-lg p-3 bg-white appearance-none" onchange="updateWeatherDisplay()">
                    </div>

                    <div id="field-where" class="hidden">
                        <label id="label-where" class="block text-gray-600 mb-1 font-bold">Location</label>
                        <input type="text" id="input-where" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Location name..." oninput="updateWeatherDisplay()">
                        <div id="weather-display" class="mt-2 text-[#4169E1] font-bold hidden flex items-center gap-2"></div>
                    </div>

                    <div id="field-restaurant" class="hidden">
                        <label class="block text-gray-600 mb-1 font-bold">Restaurant</label>
                        <input type="text" id="input-restaurant" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Restaurant name...">
                    </div>
                    
                    <div id="field-location" class="hidden">
                        <label class="block text-gray-600 mb-1 font-bold">Location</label>
                        <input type="text" id="input-location" class="w-full border border-gray-300 rounded-lg p-3" placeholder="e.g. Downtown" oninput="updateWeatherDisplay()">
                        <div id="weather-display-eat" class="mt-2 text-[#4169E1] font-bold hidden flex items-center gap-2"></div>
                    </div>

                    <div id="field-maps-link" class="hidden">
                        <label class="block text-gray-600 mb-1 font-bold">Google Maps Link</label>
                        <input type="url" id="input-maps-link" class="w-full border border-gray-300 rounded-lg p-3" placeholder="https://maps.google.com/...">
                    </div>

                    <div>
                        <label id="label-url" class="block text-gray-600 mb-1 font-bold">URL</label>
                        <input type="url" id="input-url" class="w-full border border-gray-300 rounded-lg p-3" placeholder="https://...">
                    </div>

                    <div>
                        <label class="block text-gray-600 mb-1 font-bold">Content</label>
                        <textarea id="input-content" rows="3" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Details..."></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-600 mb-1 font-bold">Remark</label>
                        <input type="text" id="input-remark" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Notes...">
                    </div>
                </div>

                <!-- Buttons Area -->
                <div class="pt-4 flex flex-col gap-3">
                    <button id="btn-save-new" onclick="saveNewItem()" class="btn-add-item w-full shadow-md">Add Item</button>
                    <div id="edit-buttons" class="hidden flex flex-col gap-3 w-full">
                        <button onclick="confirmEdit()" class="btn-primary w-full shadow-md flex justify-center items-center">
                            <i class="fas fa-save mr-2"></i> Save Edit
                        </button>
                        <button id="btn-toggle-complete" onclick="toggleCompletion()" class="btn-success w-full shadow-md flex justify-center items-center">
                            <i class="fas fa-arrow-right mr-2"></i> Move to Completed
                        </button>
                        <button onclick="deleteItem()" class="btn-danger w-full shadow-md flex justify-center items-center">
                            <i class="fas fa-trash-alt mr-2"></i> Delete Item
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let items = [];
        let currentTab = 'toeat'; 
        let currentFilter = 'All';
        let isEditMode = false;
        
        let currentCalendarDate = new Date();
        let currentCalendarRegion = 'HK'; 

        const PUBLIC_HOLIDAYS = {
            'HK': {
                '2025-01-01': 'ÂÖÉÊó¶', '2025-01-29': 'Ëæ≤ÊõÜÂπ¥Âàù‰∏Ä', '2025-01-30': 'Ëæ≤ÊõÜÂπ¥Âàù‰∫å', '2025-01-31': 'Ëæ≤ÊõÜÂπ¥Âàù‰∏â',
                '2025-04-04': 'Ê∏ÖÊòéÁØÄ', '2025-04-18': 'ËÄ∂Á©åÂèóÈõ£ÁØÄ', '2025-04-19': 'ËÄ∂Á©åÂèóÈõ£ÁØÄÁøåÊó•', '2025-04-21': 'Âæ©Ê¥ªÁØÄÊòüÊúü‰∏Ä',
                '2025-05-01': 'ÂãûÂãïÁØÄ', '2025-05-05': '‰ΩõË™ï', '2025-05-31': 'Á´ØÂçàÁØÄ', '2025-07-01': 'È¶ôÊ∏ØÁâπÂà•Ë°åÊîøÂçÄÊàêÁ´ãÁ¥ÄÂøµÊó•',
                '2025-10-01': 'ÂúãÊÖ∂Êó•', '2025-10-07': '‰∏≠ÁßãÁØÄÁøåÊó•', '2025-10-29': 'ÈáçÈôΩÁØÄ', '2025-12-25': 'ËÅñË™ïÁØÄ', '2025-12-26': 'ËÅñË™ïÁØÄÂæåÁ¨¨‰∏ÄÂÄãÈÄ±Êó•',
                '2026-01-01': 'ÂÖÉÊó¶', '2026-02-17': 'Ëæ≤ÊõÜÂπ¥Âàù‰∏Ä', '2026-02-18': 'Ëæ≤ÊõÜÂπ¥Âàù‰∫å', '2026-02-19': 'Ëæ≤ÊõÜÂπ¥Âàù‰∏â',
                '2026-04-03': 'ËÄ∂Á©åÂèóÈõ£ÁØÄ', '2026-04-04': 'ËÄ∂Á©åÂèóÈõ£ÁØÄÁøåÊó•', '2026-04-06': 'Âæ©Ê¥ªÁØÄÊòüÊúü‰∏Ä', '2026-05-01': 'ÂãûÂãïÁØÄ',
                '2026-05-25': '‰ΩõË™ïÁøåÊó•', '2026-06-19': 'Á´ØÂçàÁØÄ', '2026-07-01': 'È¶ôÊ∏ØÁâπÂà•Ë°åÊîøÂçÄÊàêÁ´ãÁ¥ÄÂøµÊó•', '2026-09-26': '‰∏≠ÁßãÁØÄÁøåÊó•',
                '2026-10-01': 'ÂúãÊÖ∂Êó•', '2026-10-19': 'ÈáçÈôΩÁØÄÁøåÊó•', '2026-12-25': 'ËÅñË™ïÁØÄ', '2026-12-26': 'ËÅñË™ïÁØÄÂæåÁ¨¨‰∏ÄÂÄãÈÄ±Êó•'
            },
            'NZ': {
                '2025-01-01': "New Year's Day", '2025-01-02': "Day after New Year's Day", '2025-02-06': "Waitangi Day",
                '2025-04-18': "Good Friday", '2025-04-21': "Easter Monday", '2025-04-25': "ANZAC Day",
                '2025-06-02': "King's Birthday", '2025-06-20': "Matariki", '2025-10-27': "Labour Day",
                '2025-12-25': "Christmas Day", '2025-12-26': "Boxing Day",
                '2026-01-01': "New Year's Day", '2026-01-02': "Day after New Year's Day", '2026-02-06': "Waitangi Day",
                '2026-04-03': "Good Friday", '2026-04-06': "Easter Monday", '2026-04-25': "ANZAC Day",
                '2026-06-01': "King's Birthday", '2026-07-10': "Matariki", '2026-10-26': "Labour Day",
                '2026-12-25': "Christmas Day", '2026-12-26': "Boxing Day"
            }
        };
        
        const COLLECTIONS = {
            'todo': 'To Do',
            'togo': 'To Go',
            'toeat': 'To Eat',
            'tobuy': 'To Buy',
            'recurring': 'Recurring',
            'completed': 'Completed',
            'mjrecord': 'MJ Record'
        };

        let itemsDataStore = {
            'To Do': [], 'To Go': [], 'To Eat': [], 'To Buy': [], 'Recurring': [], 'Completed': [], 'MJ Record': []
        };
        
        // V1.20: MJ Players Updated
        const MJ_PLAYERS = ['S', 'A', 'D', 'V', 'ÈäÄÂßê', 'ÊΩò'];
        const MJ_GUESTS = ['Guest ‚ë†', 'Guest ‚ë°', 'Guest ‚ë¢', 'Guest ‚ë£'];
        const ALL_MJ_PLAYERS = [...MJ_PLAYERS, ...MJ_GUESTS];

        let db = null;

        const firebaseConfig = {
            apiKey: "AIzaSyC5A3HUWwkH1mFU0u7mzkdLXFJ3BlYiaTI",
    authDomain: "wiilc-family.firebaseapp.com",
    projectId: "wiilc-family",
    storageBucket: "wiilc-family.firebasestorage.app",
    messagingSenderId: "855894103830",
    appId: "1:855894103830:web:12245d01c942ed803ba237"
        };

        function initApp() {
            if (firebaseConfig.projectId.includes("Ë´ãÂ°´ÂÖ•") || firebaseConfig.apiKey.includes("Ë´ãÂ°´ÂÖ•")) {
                console.warn("‚ö†Ô∏è Firebase Ë®≠ÂÆöÂ∞öÊú™Â°´ÂØ´„ÄÇ");
                const banner = document.getElementById('offline-banner');
                if (banner) banner.style.display = 'block';
                return;
            }
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                setupFirebaseListeners();
            } catch (error) { console.error("Firebase ÂàùÂßãÂåñÂ§±Êïó: ", error); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            initMjForm();
            window.addEventListener('scroll', () => {
                const navbar = document.getElementById('navbar');
                if (window.scrollY > 20) navbar.classList.add('shrink');
                else navbar.classList.remove('shrink');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.relative')) document.querySelectorAll('.find-dropdown-menu').forEach(el => el.classList.add('hidden'));
            });
            switchTab('toeat'); 
        });
        
        // Init MJ Form Inputs
        function initMjForm() {
            const container = document.getElementById('mj-players-container');
            container.innerHTML = '';
            
            // Standard Players
            MJ_PLAYERS.forEach(player => {
                const div = document.createElement('div');
                div.className = 'mj-input-group';
                div.innerHTML = `
                    <label class="mj-label">${player}</label>
                    <div class="flex gap-1 mr-2">
                        <button type="button" class="mj-sign-btn active" data-player="${player}" data-sign="+" onclick="toggleSign('${player}', '+')">+</button>
                        <button type="button" class="mj-sign-btn" data-player="${player}" data-sign="-" onclick="toggleSign('${player}', '-')">-</button>
                    </div>
                    <input type="number" inputmode="numeric" id="mj-input-${player}" class="w-full border border-gray-300 rounded-lg p-2 bg-white" placeholder="0" oninput="calculateMjTotal()">
                `;
                container.appendChild(div);
            });

            // Guests Row (One line for inputs)
            const guestsRow = document.createElement('div');
            guestsRow.className = 'guests-row mt-2';
            MJ_GUESTS.forEach(guest => {
                const item = document.createElement('div');
                item.className = 'guest-item';
                item.innerHTML = `
                    <span class="mj-label text-xs">${guest}</span>
                    <div class="flex gap-1 mb-1 justify-center">
                        <button type="button" class="mj-sign-btn active" data-player="${guest}" data-sign="+" onclick="toggleSign('${guest}', '+')">+</button>
                        <button type="button" class="mj-sign-btn" data-player="${guest}" data-sign="-" onclick="toggleSign('${guest}', '-')">-</button>
                    </div>
                    <input type="number" inputmode="numeric" id="mj-input-${guest}" class="w-full border border-gray-300 rounded-lg p-1 text-center bg-white" placeholder="0" oninput="calculateMjTotal()">
                `;
                guestsRow.appendChild(item);
            });
            container.appendChild(guestsRow);
        }

        function toggleSign(player, sign) {
            // Update UI
            const btns = document.querySelectorAll(`button[data-player="${player}"]`);
            btns.forEach(b => {
                if(b.dataset.sign === sign) b.classList.add('active');
                else b.classList.remove('active');
            });
            calculateMjTotal();
        }

        function calculateMjScore(val) {
            const res = document.getElementById('mj-calc-result');
            if(val === '') { res.textContent = '0'; return; }
            const num = parseInt(val);
            const calc = num - 200;
            res.textContent = (calc > 0 ? '+' : '') + calc;
        }

        function calculateMjTotal() {
            let total = 0;
            ALL_MJ_PLAYERS.forEach(player => {
                const plusBtn = document.querySelector(`button[data-player="${player}"][data-sign="+"]`);
                const sign = plusBtn.classList.contains('active') ? 1 : -1;
                const val = document.getElementById(`mj-input-${player}`).value;
                if(val) {
                    total += sign * parseInt(val);
                }
            });
            document.getElementById('mj-total-sum').textContent = total;
        }
            
        function setupFirebaseListeners() {
            if (!db) return;
            Object.values(COLLECTIONS).forEach(collectionName => {
                db.collection(collectionName).onSnapshot((querySnapshot) => {
                    const collectionItems = [];
                    querySnapshot.forEach((doc) => {
                        collectionItems.push({ 
                            id: doc.id, ...doc.data(), sourceCollection: collectionName 
                        });
                    });
                    itemsDataStore[collectionName] = collectionItems;
                    updateAllItemsAndRender();
                }, (error) => console.error(`Error from ${collectionName}: `, error));
            });
        }

        function updateAllItemsAndRender() {
            items = Object.values(itemsDataStore).flat();
            renderList();
            calculateRecurringTotal();
            renderMjTotals(); // Update MJ Totals
            
            const emptyState = document.getElementById('empty-state');
            if (currentTab !== 'calendar') {
                if (currentTab === 'mjrecord') {
                    if (document.getElementById('mj-list-container').children.length === 0) {
                        emptyState.textContent = "No records found.";
                        emptyState.classList.remove('hidden');
                    } else {
                        emptyState.classList.add('hidden');
                    }
                } else {
                    if (items.length === 0 && Object.values(itemsDataStore).every(arr => arr.length === 0)) {
                         emptyState.textContent = "Loading items...";
                         emptyState.classList.remove('hidden');
                    } else if (document.getElementById('list-container').children.length === 0) {
                        emptyState.textContent = "No items found.";
                        emptyState.classList.remove('hidden');
                    } else {
                        emptyState.classList.add('hidden');
                    }
                }
            } else {
                emptyState.classList.add('hidden');
            }
        }

        // --- MJ Total Calculation for Table Header ---
        function renderMjTotals() {
            const mjItems = itemsDataStore['MJ Record'] || [];
            const totals = {};
            ALL_MJ_PLAYERS.forEach(p => totals[p] = 0);

            mjItems.forEach(item => {
                ALL_MJ_PLAYERS.forEach(p => {
                    if(item.scores && item.scores[p]) {
                        totals[p] += parseInt(item.scores[p]);
                    }
                });
            });

            const headerRow = document.getElementById('mj-header-totals');
            let html = `<td>Total</td>`;
            ALL_MJ_PLAYERS.forEach(p => {
                const val = totals[p];
                const colorClass = val >= 0 ? 'text-green-600' : 'text-red-500';
                const sign = val > 0 ? '+' : '';
                html += `<td class="${colorClass}">${sign}${val}</td>`;
            });
            html += `<td></td>`; // Remark column spacer
            headerRow.innerHTML = html;
        }

        function switchTab(tabName) {
            currentTab = tabName;
            closeMobileMenu();
            setFilter('All'); 

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-[#4169E1]', 'text-white', 'shadow-md');
                btn.classList.add('text-gray-600', 'hover:bg-blue-50');
            });
            
            const activeBtnD = document.getElementById(`nav-${tabName}-d`);
            const activeBtnM = document.getElementById(`nav-${tabName}-m`);
            if(activeBtnD) {
                activeBtnD.classList.remove('text-gray-600', 'hover:bg-blue-50');
                activeBtnD.classList.add('bg-[#4169E1]', 'text-white', 'shadow-md');
            }
            if(activeBtnM) {
                activeBtnM.classList.remove('text-gray-600', 'hover:bg-blue-50');
                activeBtnM.classList.add('bg-[#4169E1]', 'text-white', 'shadow-md');
            }

            const desktopTitles = {
                'calendar': 'üóìÔ∏è HKÔºèNZ Holiday',
                'mjrecord': 'üÄÑ MJ Record',
                'todo': 'üõ†Ô∏è To Do List',
                'togo': 'üöÄ Places To Go',
                'toeat': 'üçü Food To Eat',
                'tobuy': 'üõí Things To Buy',
                'recurring': 'üîÑ Recurring Tasks',
                'completed': 'üèÅ Completed History'
            };
            const mobileTitles = {
                'calendar': 'üóìÔ∏è HKÔºèNZ Holiday',
                'mjrecord': 'üÄÑ MJ Record',
                'todo': 'üõ†Ô∏è To Do',
                'togo': 'üöÄ To Go',
                'toeat': 'üçü To Eat',
                'tobuy': 'üõí To Buy',
                'recurring': 'üîÑ Recurring',
                'completed': 'üèÅ Completed'
            };
            
            document.getElementById('desktop-page-title').textContent = desktopTitles[tabName];
            document.getElementById('mobile-page-title').textContent = mobileTitles[tabName];

            // Visibility Toggles
            const show = (id) => document.getElementById(id)?.classList.remove('hidden');
            const hide = (id) => document.getElementById(id)?.classList.add('hidden');
            const showFlex = (id) => { const el = document.getElementById(id); if(el) { el.classList.remove('hidden'); el.style.display = 'flex'; }};
            const hideEl = (id) => { const el = document.getElementById(id); if(el) { el.classList.add('hidden'); el.style.display = 'none'; }};

            // Reset all first
            hide('desktop-calendar-controls'); hide('mobile-calendar-controls');
            hide('calendar-view'); hide('mj-record-view'); hide('list-container');
            showFlex('desktop-find-container'); showFlex('mobile-find-container');
            const desktopAdd = document.getElementById('desktop-add-container');
            const mobileAdd = document.getElementById('mobile-add-container');
            const versionFooter = document.getElementById('version-footer');
            const addBtnTextD = document.getElementById('desktop-add-text');
            const addBtnTextM = document.getElementById('mobile-add-text');

            desktopAdd.style.visibility = 'visible';
            mobileAdd.style.display = 'block';
            versionFooter.classList.add('hidden');
            
            // Text for Add Button
            if (tabName === 'mjrecord') {
                addBtnTextD.textContent = "Add Record";
                addBtnTextM.textContent = "Add Record";
            } else {
                addBtnTextD.textContent = "Add Item";
                addBtnTextM.textContent = "Add Item";
            }

            if (tabName === 'calendar') {
                desktopAdd.style.visibility = 'hidden';
                mobileAdd.style.display = 'none';
                hideEl('desktop-find-container'); hideEl('mobile-find-container');
                showFlex('desktop-calendar-controls'); showFlex('mobile-calendar-controls');
                show('calendar-view');
                renderCalendar();
            } else if (tabName === 'mjrecord') {
                hideEl('desktop-find-container'); hideEl('mobile-find-container');
                show('mj-record-view');
            } else {
                show('list-container');
                if (tabName === 'completed') {
                    desktopAdd.style.visibility = 'hidden';
                    mobileAdd.style.display = 'none';
                    versionFooter.classList.remove('hidden');
                }
            }
            
            // Re-render to filter correct items
            updateAllItemsAndRender();
        }

        // --- Render Lists ---
        function renderList() {
            // Standard List
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            
            // MJ List
            const mjContainer = document.getElementById('mj-list-container');
            mjContainer.innerHTML = '';

            let filteredItems = items.filter(item => {
                if (currentTab === 'mjrecord') return item.sourceCollection === 'MJ Record';
                if (currentTab === 'calendar') return false;
                
                let isMatchTab = false;
                if (currentTab === 'completed') isMatchTab = (item.sourceCollection === 'Completed');
                else isMatchTab = (item.sourceCollection === COLLECTIONS[currentTab]);
                
                let isMatchUser = true;
                if (currentFilter !== 'All') {
                    const itemWho = item.forWho || [];
                    isMatchUser = itemWho.includes(currentFilter) || itemWho.includes('All');
                }
                return isMatchTab && isMatchUser;
            });

            // Sort: Newest first (ID desc)
            filteredItems.sort((a, b) => b.number - a.number); 

            if (currentTab === 'mjrecord') {
                filteredItems.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.onclick = () => openEditModal(item.id, 'MJ Record');
                    // item.scores is object {S: 10, A: 20...}
                    let tds = `<td>${item.date}</td>`;
                    ALL_MJ_PLAYERS.forEach(p => {
                        const val = item.scores?.[p] || 0;
                        const sign = val > 0 ? '+' : '';
                        const colorClass = val > 0 ? 'text-green-600' : (val < 0 ? 'text-red-500' : 'text-gray-400');
                        tds += `<td class="${colorClass}">${sign}${val}</td>`;
                    });
                    tds += `<td class="text-gray-500 text-sm max-w-[100px] truncate">${item.remark || ''}</td>`;
                    tr.innerHTML = tds;
                    mjContainer.appendChild(tr);
                });
            } else {
                filteredItems.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'item-card'; 
                    div.onclick = (e) => {
                        if (!e.target.closest('.btn-link') && !e.target.closest('.btn-map-link')) {
                            openEditModal(item.id, item.sourceCollection);
                        }
                    };
                    // ... (Card rendering logic same as before) ...
                    const itemWho = item.forWho || [];
                    const tagsHtml = itemWho.map(p => `<span class="display-chip">${p}</span>`).join(' ');
                    const topRow = `<div class="flex items-center gap-3 mb-1"><span class="font-mono text-gray-500 font-bold text-xl">#${item.number}</span><div class="flex flex-wrap gap-1">${tagsHtml}</div></div>`;
                    const titleRow = `<div class="font-bold text-[#4169E1] mb-2 text-xl break-words">${item.title}</div>`;
                    let detailsHtml = '<div class="flex flex-wrap gap-4 text-sm text-gray-600 items-center">';
                    if (item.tab === 'recurring') {
                        if (item.frequency) detailsHtml += `<span><i class="fas fa-sync-alt mr-1"></i> ${item.frequency}</span>`;
                        if (item.payment) detailsHtml += `<span class="text-green-600 font-bold">NZ$${item.payment}</span>`;
                        if (item.endDate) detailsHtml += `<span class="text-gray-500 ml-2">End: ${formatDate(item.endDate)}</span>`;
                    } else {
                        if (item.deadline) {
                            let weatherHtml = '';
                            if (item.tab === 'togo') {
                                const weatherText = getWeatherEmoji(item.deadline, item.where);
                                const emoji = weatherText.split(' ')[0]; const temp = weatherText.split(' ')[1];
                                weatherHtml = `<span title="${weatherText}">${emoji} ${temp}</span>`;
                            } else if (item.tab === 'toeat') {
                                const weatherText = getWeatherEmoji(item.deadline, item.location);
                                const emoji = weatherText.split(' ')[0]; const temp = weatherText.split(' ')[1];
                                weatherHtml = `<span title="${weatherText}">${emoji} ${temp}</span>`;
                            } else if (item.location) {
                                const weatherText = getWeatherEmoji(item.deadline, item.location);
                                const emoji = weatherText.split(' ')[0]; const temp = weatherText.split(' ')[1];
                                weatherHtml = `<span title="${weatherText}">${emoji} ${temp}</span>`;
                            }
                            // V1.19: Icon update
                            let iconClass = 'fa-calendar-alt';
                            if (item.tab === 'togo' || item.tab === 'toeat') iconClass = 'fa-plane-departure';
                            if (item.tab === 'todo' || item.tab === 'tobuy') iconClass = 'fa-hourglass-half';
                            
                            detailsHtml += `<span><i class="fas ${iconClass} mr-1"></i> ${formatDate(item.deadline)} ${weatherHtml}</span>`;
                        }
                        if (item.where) detailsHtml += `<span><i class="fas fa-map-marker-alt mr-1"></i> ${item.where}</span>`;
                        if (item.restaurant) detailsHtml += `<span><i class="fas fa-utensils mr-1"></i> ${item.restaurant}</span>`;
                        if (item.location) detailsHtml += `<span><i class="fas fa-map-pin mr-1"></i> ${item.location}</span>`;
                        if (item.frequency) detailsHtml += `<span><i class="fas fa-sync-alt mr-1"></i> ${item.frequency}</span>`;
                    }
                    if (item.mapsLink) detailsHtml += `<a href="${item.mapsLink}" target="_blank" class="btn-map-link"><i class="fas fa-map-marker-alt"></i> Map</a>`;
                    if (item.url) detailsHtml += `<a href="${item.url}" target="_blank" class="btn-link"><i class="fas fa-link"></i> Link</a>`;
                    detailsHtml += '</div>';
                    div.innerHTML = `${topRow}${titleRow}${detailsHtml}`;
                    container.appendChild(div);
                });
            }
        }

        // --- Shared Helper Functions ---
        function getAutoEmoji(title) {
            if (!title) return '';
            const lowerTitle = title.toLowerCase();
            const map = {
                'gym': 'üèãÔ∏è', 'sport': 'üèÉ', 'run': 'üèÉ', 'walk': 'üö∂', 'doctor': 'üë®‚Äç‚öïÔ∏è', 'med': 'üíä', 'hospital': 'üè•',
                'eat': 'üçΩÔ∏è', 'dinner': 'üçΩÔ∏è', 'lunch': 'üç±', 'breakfast': 'ü•û', 'food': 'üçî',
                'shop': 'üõçÔ∏è', 'buy': 'üõí', 'market': 'üè™', 'study': 'üìö', 'book': 'üìñ', 'read': 'üìñ', 'school': 'üè´',
                'flight': '‚úàÔ∏è', 'trip': 'üß≥', 'travel': '‚úàÔ∏è', 'pay': 'üí∏', 'bill': 'üßæ', 'rent': 'üè†',
                'car': 'üöó', 'drive': 'üöó', 'movie': 'üé¨', 'cinema': 'üçø', 'birthday': 'üéÇ', 'party': 'üéâ'
            };
            if (/^[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/u.test(title)) return ''; 
            for (const key in map) if (lowerTitle.includes(key)) return map[key] + ' ';
            return '';
        }
        function setCalendarRegion(region) {
            currentCalendarRegion = region;
            document.querySelectorAll('.btn-region').forEach(btn => btn.classList.remove('active'));
            if(region === 'HK') { document.getElementById('btn-hk-d').classList.add('active'); document.getElementById('btn-hk-m').classList.add('active'); } 
            else { document.getElementById('btn-nz-d').classList.add('active'); document.getElementById('btn-nz-m').classList.add('active'); }
            renderCalendar();
        }
        function changeMonth(delta) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta); renderCalendar(); }
        function renderCalendar() {
            if (currentTab !== 'calendar') return;
            const year = currentCalendarDate.getFullYear(); const month = currentCalendarDate.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
            const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate(); const startingDay = firstDay.getDay(); 
            const calendarDaysDiv = document.getElementById('calendar-days'); calendarDaysDiv.innerHTML = '';
            for (let i = 0; i < startingDay; i++) { const blank = document.createElement('div'); blank.className = 'calendar-day bg-gray-50'; calendarDaysDiv.appendChild(blank); }
            const holidays = PUBLIC_HOLIDAYS[currentCalendarRegion];
            for (let i = 1; i <= daysInMonth; i++) {
                const dayDiv = document.createElement('div'); dayDiv.className = 'calendar-day';
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dateObj = new Date(year, month, i); const dayOfWeek = dateObj.getDay(); 
                const holidayName = holidays[dateString]; const isSunday = (dayOfWeek === 0);
                let textColorClass = 'text-black-day'; let holidayText = '';
                if (holidayName) { textColorClass = 'text-red-holiday'; holidayText = `<div class="holiday-name">${holidayName}</div>`; } 
                else if (isSunday) { textColorClass = 'text-red-holiday'; }
                dayDiv.innerHTML = `<div class="day-number ${textColorClass}">${i}</div>${holidayText}`;
                calendarDaysDiv.appendChild(dayDiv);
            }
        }
        function calculateRecurringTotal() {
            if (currentTab !== 'recurring') { document.getElementById('recurring-summary').classList.add('hidden'); return; }
            let recurringItems = itemsDataStore['Recurring'] || [];
            if (currentFilter !== 'All') recurringItems = recurringItems.filter(item => { const itemWho = item.forWho || []; return itemWho.includes(currentFilter) || itemWho.includes('All'); });
            let monthlyTotal = 0;
            recurringItems.forEach(item => {
                if (item.payment && !isNaN(item.payment)) {
                    const amount = parseFloat(item.payment);
                    switch(item.frequency) {
                        case 'Daily': monthlyTotal += amount * 30; break; case 'Weekly': monthlyTotal += amount * 4; break;
                        case 'Monthly': monthlyTotal += amount; break; case 'Quarterly': monthlyTotal += amount / 3; break;
                        case 'Yearly': monthlyTotal += amount / 12; break;
                    }
                }
            });
            const formattedTotal = new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(monthlyTotal);
            document.getElementById('recurring-total-display').textContent = `Average Payment NZ$${formattedTotal} / mo`;
            document.getElementById('recurring-summary').classList.remove('hidden');
        }
        function toggleFindDropdown(btn) { const dropdown = btn.nextElementSibling; document.querySelectorAll('.find-dropdown-menu').forEach(el => { if(el !== dropdown) el.classList.add('hidden'); }); dropdown.classList.toggle('hidden'); }
        function setFilter(who) {
            currentFilter = who; document.getElementById('find-label-d').textContent = `Filter: ${who}`; document.getElementById('find-label-m').textContent = `Filter: ${who}`;
            document.querySelectorAll('.find-option').forEach(opt => { if(opt.textContent === who) opt.classList.add('active'); else opt.classList.remove('active'); });
            document.querySelectorAll('.find-dropdown-menu').forEach(el => el.classList.add('hidden'));
            renderList(); calculateRecurringTotal();
        }
        function getTabDisplayName(tab) {
            const names = { 'calendar': 'üóìÔ∏è HKÔºèNZ Holiday', 'mjrecord': 'üÄÑ MJ Record', 'todo': 'üõ†Ô∏è To Do', 'togo': 'üöÄ To Go', 'toeat': 'üçü To Eat', 'tobuy': 'üõí To Buy', 'recurring': 'üîÑ Recurring', 'completed': 'üèÅ Completed' };
            return names[tab] || 'Item';
        }
        function getCollectionNameByTab(tab) { return COLLECTIONS[tab]; }
        function toggleMobileMenu() { document.getElementById('mobile-menu').classList.toggle('open'); }
        function closeMobileMenu() { document.getElementById('mobile-menu').classList.remove('open'); }
        function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString); const d = String(date.getDate()).padStart(2, '0'); const m = String(date.getMonth() + 1).padStart(2, '0'); const y = date.getFullYear(); return `${d}-${m}-${y}`; }
        function getWeatherEmoji(dateStr, location) { if (!dateStr) return ''; const date = new Date(dateStr); const month = date.getMonth(); const isSummer = (month >= 11 || month <= 1); const isWinter = (month >= 5 && month <= 7); const locationSeed = location ? location.length : 0; const daySeed = date.getDate(); const randomness = (locationSeed + daySeed) % 10; const sunny = ['‚òÄÔ∏è', 'üå§Ô∏è', 'üòé', 'üèñÔ∏è']; const rainy = ['üåßÔ∏è', 'üå¶Ô∏è', '‚òî', '‚òÅÔ∏è']; const neutral = ['‚òÅÔ∏è', '‚õÖ', 'üí®']; let emoji = ''; let tempRange = [15, 20]; if (isSummer) { emoji = randomness > 2 ? sunny[randomness % sunny.length] : neutral[0]; tempRange = [20, 28]; } else if (isWinter) { emoji = randomness > 3 ? rainy[randomness % rainy.length] : neutral[0]; tempRange = [5, 14]; } else { emoji = neutral[randomness % neutral.length]; tempRange = [12, 22]; } const temp = tempRange[0] + (randomness % (tempRange[1] - tempRange[0])); const locText = location ? location : "New Zealand"; return `${emoji} ${temp}¬∞C in ${locText}`; }
        function updateWeatherDisplay() { let displayDiv = null; let locationVal = ''; if (currentTab === 'togo') { displayDiv = document.getElementById('weather-display'); locationVal = document.getElementById('input-where').value; } else if (currentTab === 'toeat' || currentTab === 'todo' || currentTab === 'tobuy' || currentTab === 'recurring') { displayDiv = document.getElementById('weather-display-eat'); locationVal = document.getElementById('input-location').value; } else { return; } const dateVal = document.getElementById('input-deadline').value; if (dateVal && displayDiv) { const weatherText = getWeatherEmoji(dateVal, locationVal); displayDiv.textContent = `Forecast: ${weatherText}`; displayDiv.classList.remove('hidden'); } else if (displayDiv) { displayDiv.classList.add('hidden'); } }

        function openModal() {
            if (!db) { alert("Firebase Êú™ÈÄ£Á∑öÔºÅ"); return; }
            isEditMode = false;
            resetForm();
            setupFormFields(currentTab);
            const tabName = getTabDisplayName(currentTab);
            document.getElementById('modal-title').textContent = 'Add Item';
            document.getElementById('label-title').textContent = `${tabName} Heading`;
            const saveBtn = document.getElementById('btn-save-new');
            saveBtn.textContent = (currentTab === 'mjrecord') ? "Add Record" : `${tabName} Add Item`;
            saveBtn.classList.remove('hidden');
            document.getElementById('edit-buttons').classList.add('hidden');
            document.getElementById('weather-display').classList.add('hidden');
            document.getElementById('weather-display-eat').classList.add('hidden');
            setTimeout(() => { const scrollContainer = document.getElementById('modal-content-scroll'); if(scrollContainer) scrollContainer.scrollTop = 0; }, 10);
            document.getElementById('item-modal').classList.remove('hidden');
        }

        function openEditModal(id, sourceCollection) {
            isEditMode = true;
            const item = items.find(i => i.id === id && i.sourceCollection === sourceCollection);
            if (!item) return;
            resetForm();
            // Handle MJ vs Standard
            if (sourceCollection === 'MJ Record') {
                currentTab = 'mjrecord'; // Force tab state for proper field setup
                setupFormFields('mjrecord');
                const idInput = document.getElementById('item-id');
                idInput.value = item.id;
                idInput.dataset.collection = sourceCollection;
                
                document.getElementById('mj-date').value = item.date;
                document.getElementById('mj-remark').value = item.remark || '';
                ALL_MJ_PLAYERS.forEach(p => {
                    const score = item.scores[p] || 0;
                    const sign = score >= 0 ? '+' : '-';
                    // Update buttons
                    const btns = document.querySelectorAll(`button[data-player="${p}"]`);
                    btns.forEach(b => {
                        if(b.dataset.sign === sign) b.classList.add('active');
                        else b.classList.remove('active');
                    });
                    document.getElementById(`mj-input-${p}`).value = Math.abs(score);
                });
                calculateMjTotal();
                
                document.getElementById('modal-title').textContent = 'Edit Record';
            } else {
                setupFormFields(item.tab);
                const tabName = getTabDisplayName(item.tab);
                document.getElementById('label-title').textContent = `${tabName} Heading`;
                const idInput = document.getElementById('item-id');
                idInput.value = item.id;
                idInput.dataset.collection = sourceCollection; 
                document.getElementById('input-title').value = item.title;
                document.getElementById('input-url').value = item.url || '';
                document.getElementById('input-content').value = item.content || '';
                document.getElementById('input-remark').value = item.remark || '';
                document.getElementById('input-maps-link').value = item.mapsLink || ''; 
                const itemWho = item.forWho || [];
                document.querySelectorAll('.select-chip').forEach(chip => { if (itemWho.includes(chip.dataset.value)) chip.classList.add('selected'); });
                if (document.getElementById('input-deadline')) document.getElementById('input-deadline').value = item.deadline || '';
                if (document.getElementById('input-frequency')) document.getElementById('input-frequency').value = item.frequency || '';
                if (document.getElementById('input-where')) document.getElementById('input-where').value = item.where || '';
                if (document.getElementById('input-restaurant')) document.getElementById('input-restaurant').value = item.restaurant || '';
                if (document.getElementById('input-location')) document.getElementById('input-location').value = item.location || '';
                if (document.getElementById('input-payment')) document.getElementById('input-payment').value = item.payment || '';
                if (document.getElementById('input-enddate')) document.getElementById('input-enddate').value = item.endDate || ''; 
                updateWeatherDisplay();
                document.getElementById('modal-title').textContent = 'Edit / View Item';
            }

            document.getElementById('btn-save-new').classList.add('hidden');
            document.getElementById('edit-buttons').classList.remove('hidden');
            
            // MJ record doesn't use toggleCompletion but we keep structure
            const toggleBtn = document.getElementById('btn-toggle-complete');
            if(sourceCollection === 'MJ Record') {
                toggleBtn.classList.add('hidden'); // Hide move/complete for MJ
            } else {
                toggleBtn.classList.remove('hidden');
                if (item.isCompleted) {
                    toggleBtn.innerHTML = '<i class="fas fa-undo mr-2"></i> Return Back';
                    toggleBtn.className = 'btn-success w-full shadow-md flex justify-center items-center'; 
                } else {
                    // V1.18: Updated icon to arrow-right
                    toggleBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i> Move to Completed';
                    toggleBtn.className = 'btn-success w-full shadow-md flex justify-center items-center';
                }
            }
            setTimeout(() => { const scrollContainer = document.getElementById('modal-content-scroll'); if(scrollContainer) scrollContainer.scrollTop = 0; }, 10);
            document.getElementById('item-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('item-modal').classList.add('hidden'); }
        document.getElementById('item-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('item-modal')) closeModal(); });

        function setupFormFields(tab) {
            // Hide standard fields
            const fields = ['deadline', 'frequency', 'payment', 'enddate', 'where', 'restaurant', 'location', 'maps-link'];
            fields.forEach(f => document.getElementById(`field-${f}`).classList.add('hidden'));
            
            // Toggle containers
            if (tab === 'mjrecord') {
                document.getElementById('mj-form-container').classList.remove('hidden');
                document.getElementById('standard-form-container').classList.add('hidden');
                document.getElementById('mj-date').valueAsDate = new Date();
                return;
            } else {
                document.getElementById('mj-form-container').classList.add('hidden');
                document.getElementById('standard-form-container').classList.remove('hidden');
            }

            document.getElementById('label-where').textContent = 'Location';
            document.getElementById('label-url').textContent = 'URL';
            document.getElementById('label-deadline').textContent = 'Deadline (if any)';

            if (tab === 'todo') {
                document.getElementById('field-deadline').classList.remove('hidden');
                document.getElementById('field-location').classList.remove('hidden');
                document.getElementById('field-maps-link').classList.remove('hidden');
            } else if (tab === 'togo') {
                document.getElementById('field-deadline').classList.remove('hidden');
                document.getElementById('field-where').classList.remove('hidden');
                document.getElementById('field-maps-link').classList.remove('hidden');
                document.getElementById('label-where').textContent = 'Location';
                document.getElementById('label-url').textContent = 'URL';
                document.getElementById('label-deadline').textContent = 'Departure Date (if any)';
            } else if (tab === 'toeat') {
                document.getElementById('field-deadline').classList.remove('hidden');
                document.getElementById('field-restaurant').classList.remove('hidden');
                document.getElementById('field-location').classList.remove('hidden');
                document.getElementById('field-maps-link').classList.remove('hidden');
                document.getElementById('label-url').textContent = 'URL';
                document.getElementById('label-deadline').textContent = 'Departure Date (if any)';
            } else if (tab === 'tobuy') {
                document.getElementById('field-deadline').classList.remove('hidden');
                document.getElementById('field-location').classList.remove('hidden');
                document.getElementById('field-maps-link').classList.remove('hidden');
            } else if (tab === 'recurring') {
                document.getElementById('field-frequency').classList.remove('hidden');
                document.getElementById('field-payment').classList.remove('hidden');
                document.getElementById('field-enddate').classList.remove('hidden'); 
                document.getElementById('field-location').classList.remove('hidden');
                document.getElementById('field-maps-link').classList.remove('hidden');
            }
        }

        function toggleWho(el) { el.classList.toggle('selected'); }
        function getSelectedWho() {
            const selected = [];
            document.querySelectorAll('.select-chip.selected').forEach(el => selected.push(el.dataset.value));
            return selected;
        }

        function resetForm() {
            // Standard
            document.getElementById('item-id').value = '';
            document.getElementById('input-title').value = '';
            document.getElementById('input-url').value = '';
            document.getElementById('input-content').value = '';
            document.getElementById('input-remark').value = '';
            document.getElementById('input-deadline').value = '';
            document.getElementById('input-where').value = '';
            document.getElementById('input-restaurant').value = '';
            document.getElementById('input-location').value = '';
            document.getElementById('input-frequency').value = '';
            document.getElementById('input-payment').value = '';
            document.getElementById('input-enddate').value = '';
            document.getElementById('input-maps-link').value = '';
            document.querySelectorAll('.select-chip').forEach(el => el.classList.remove('selected'));
            
            // MJ
            document.getElementById('mj-calc-input').value = '';
            document.getElementById('mj-calc-result').textContent = '0';
            document.getElementById('mj-total-sum').textContent = '0';
            document.getElementById('mj-remark').value = '';
            ALL_MJ_PLAYERS.forEach(p => {
                const btns = document.querySelectorAll(`button[data-player="${p}"]`);
                btns.forEach(b => {
                    if(b.dataset.sign === '+') b.classList.add('active');
                    else b.classList.remove('active');
                });
                document.getElementById(`mj-input-${p}`).value = '';
            });
        }

        function generateUniqueNumber() {
            const max = items.reduce((prev, current) => (current.number > prev ? current.number : prev), 1000);
            return max + 1;
        }

        function saveNewItem() {
            if (!db) { alert("Please connect Firebase!"); return; }
            
            const newNumber = generateUniqueNumber();
            
            if (currentTab === 'mjrecord') {
                // Save MJ Record
                const dateVal = document.getElementById('mj-date').value;
                if(!dateVal) { alert("Please select a date"); return; }
                
                const scores = {};
                ALL_MJ_PLAYERS.forEach(p => {
                    const plusBtn = document.querySelector(`button[data-player="${p}"][data-sign="+"]`);
                    const sign = plusBtn.classList.contains('active') ? 1 : -1;
                    const val = document.getElementById(`mj-input-${p}`).value || 0;
                    scores[p] = sign * parseInt(val);
                });
                
                db.collection('MJ Record').doc(String(newNumber)).set({
                    number: newNumber,
                    tab: 'mjrecord', // Internal use
                    date: dateVal,
                    scores: scores,
                    remark: document.getElementById('mj-remark').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => closeModal()).catch(e => console.error(e));
                
            } else {
                // Standard Save
                let title = document.getElementById('input-title').value.trim();
                if (!title) { alert('Please enter a Heading!'); return; }
                const emoji = getAutoEmoji(title);
                if(emoji) title = emoji + title;
                const collectionName = getCollectionNameByTab(currentTab);

                db.collection(collectionName).doc(String(newNumber)).set({
                    number: newNumber,
                    tab: currentTab,
                    isCompleted: false,
                    title: title,
                    forWho: getSelectedWho(),
                    url: document.getElementById('input-url').value,
                    content: document.getElementById('input-content').value,
                    remark: document.getElementById('input-remark').value,
                    deadline: document.getElementById('input-deadline').value,
                    frequency: document.getElementById('input-frequency').value,
                    payment: document.getElementById('input-payment').value,
                    endDate: document.getElementById('input-enddate').value, 
                    where: document.getElementById('input-where').value,
                    restaurant: document.getElementById('input-restaurant').value,
                    location: document.getElementById('input-location').value,
                    mapsLink: document.getElementById('input-maps-link').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => closeModal()).catch(e => console.error(e));
            }
        }

        function confirmEdit() {
            if (!db) return;
            const id = document.getElementById('item-id').value;
            const collectionName = document.getElementById('item-id').dataset.collection;
            
            if (collectionName === 'MJ Record') {
                const scores = {};
                ALL_MJ_PLAYERS.forEach(p => {
                    const plusBtn = document.querySelector(`button[data-player="${p}"][data-sign="+"]`);
                    const sign = plusBtn.classList.contains('active') ? 1 : -1;
                    const val = document.getElementById(`mj-input-${p}`).value || 0;
                    scores[p] = sign * parseInt(val);
                });
                
                db.collection(collectionName).doc(id).update({
                    date: document.getElementById('mj-date').value,
                    scores: scores,
                    remark: document.getElementById('mj-remark').value
                }).then(() => closeModal()).catch(e => console.error(e));
            } else {
                db.collection(collectionName).doc(id).update({
                    title: document.getElementById('input-title').value,
                    forWho: getSelectedWho(),
                    url: document.getElementById('input-url').value,
                    content: document.getElementById('input-content').value,
                    remark: document.getElementById('input-remark').value,
                    deadline: document.getElementById('input-deadline').value,
                    frequency: document.getElementById('input-frequency').value,
                    payment: document.getElementById('input-payment').value,
                    endDate: document.getElementById('input-enddate').value, 
                    where: document.getElementById('input-where').value,
                    restaurant: document.getElementById('input-restaurant').value,
                    location: document.getElementById('input-location').value,
                    mapsLink: document.getElementById('input-maps-link').value
                }).then(() => closeModal()).catch(e => console.error(e));
            }
        }

        function deleteItem() {
            if (!db) return;
            if (confirm('Are you sure delete this item?')) {
                const id = document.getElementById('item-id').value;
                const collectionName = document.getElementById('item-id').dataset.collection;
                db.collection(collectionName).doc(id).delete().then(() => closeModal()).catch(e => console.error(e));
            }
        }

        function launchFireworks() {
            const canvas = document.getElementById('fireworks-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            let particles = [];
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            function createFirework(x, y) {
                for (let i = 0; i < 30; i++) {
                    particles.push({
                        x: x, y: y,
                        vx: (Math.random() - 0.5) * 10,
                        vy: (Math.random() - 0.5) * 10,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        life: 100
                    });
                }
            }
            createFirework(canvas.width / 2, canvas.height / 2);
            setTimeout(() => createFirework(canvas.width / 3, canvas.height / 3), 200);
            setTimeout(() => createFirework(canvas.width * 2 / 3, canvas.height * 2 / 3), 400);
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (let i = 0; i < particles.length; i++) {
                    let p = particles[i];
                    p.x += p.vx; p.y += p.vy; p.life--; p.vy += 0.1;
                    ctx.fillStyle = p.color; ctx.globalAlpha = p.life / 100;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI * 2); ctx.fill();
                }
                particles = particles.filter(p => p.life > 0);
                if (particles.length > 0) requestAnimationFrame(animate);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            animate();
        }

        function toggleCompletion() {
            if (!db) return;
            const id = document.getElementById('item-id').value;
            const currentCollection = document.getElementById('item-id').dataset.collection;
            const item = items.find(i => i.id === id && i.sourceCollection === currentCollection);
            
            if (item) {
                const batch = db.batch();
                const oldRef = db.collection(currentCollection).doc(id);
                let newCollectionName = '';
                let newIsCompleted = false;

                if (item.isCompleted) {
                    newCollectionName = COLLECTIONS[item.tab]; 
                    newIsCompleted = false;
                } else {
                    newCollectionName = 'Completed';
                    newIsCompleted = true;
                    launchFireworks();
                }

                const newRef = db.collection(newCollectionName).doc(id);
                const dataToMove = { ...item };
                delete dataToMove.id; delete dataToMove.sourceCollection; 
                dataToMove.isCompleted = newIsCompleted;

                batch.set(newRef, dataToMove);
                batch.delete(oldRef);
                batch.commit().then(() => closeModal()).catch(e => console.error(e));
            }
        }
    </script>
</body>
</html>
